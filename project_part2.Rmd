---
title: "Application Part Big Data for Economists Seminar"
author: "Marc Richter and Jingyan Yang"
date: "25 4 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set up work space

```{r}

rm(list = ls())

library(rstudioapi)
library(mice)
library(dplyr)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

train_data <- read.csv("./training.csv")

X_test <- read.csv("./X_test.csv")


```

## Overview our data

Let's have a look at our data. We have no data set information/fact sheet so we will have to figure out the content ourselves...

```{r, echo=FALSE}
#head(train_data)

summary(train_data)

```

We have the following columns:

* ID: just the row ID
* address: addresses of the homes . sometimes with street name, street number, sometimes only postcode and town... pretty useless. we have the zipcode in an additional column anyway
* area: should be the total built area of the home.
* area_useable: the area of the home including land
* date: date of advertisement release
* date available
* home_type , ca. 190 categories
* municipality . probably won't use, have post code
* newly_built
* price : our dependent variable in this exercise
* rooms : number of rooms
* street: street name, won't use
* year: year of advertisment release
* year_built
* zipcode
* number of dummy variables:
  + balcony
  + basemnt
  + bath_tube
  + building_plot
  + cabletv
  + ceiling
  + cheminee
  + elevator
  + first_time
  + furnished
  + kids_friendly
  + laundry
  + minergie
  + municipality
  + new building
  + oldbuilding
  + oven
  + parking_indoor
  + parking_outside
  + playground
  + pool
  + quiet
  + raisedgroundfloor
  + sale
  + sunny
  + terrace
  + topstorage
  + veranda
  + wheelchair

```{r}
# code from https://www.r-bloggers.com/imputing-missing-data-with-r-mice-package/

pMiss <- function(x){sum(is.na(x))/length(x)*100}
apply(train_data,2, pMiss)
```

This looks... bad ..^^

Leaving out all rows with missing data is not an option, as it would leave us with pretty much no data (and for additional reasons like possible bias - the data is most likely not missing completely at random).

One major problem: our dummy variable all only contain ones and NA's. This way, we have no way of knowing which of the NA's are actually NA's and which are 0s.

First approach: Coding all NA's in dummy vars to 0. New meaning of predictor: not "does have ..." but "characteristic ... is mentioned".

```{r}

# i have done this manually because i didn't find a nice solution in R to select columns conditional on mean , min and max (would all be 1)
dummy_cols <- c("balcony", "basement", "bath_tube", "building_plot", "cabletv", "ceiling", "cheminee", "elevator", "first_time", "furnished", "kids_friendly", "laundry", "minergie", "new_building", "oldbuilding", "oven", "parking_indoor", "parking_outside", "playground", "pool", "quiet", "raised_groundfloor", "sale", "sunny", "terrace", "topstorage", "veranda", "wheelchair")

train_without_dummyNA <- train_data %>% mutate_at(.vars = dummy_cols, .funs = funs(ifelse(is.na(.), 0, .)))

apply(train_without_dummyNA,2, pMiss)

train_imputed <- train_without_dummyNA[1:100,]
train_imputed <- mice(train_imputed, m = 2, method = "mean", maxit = 50, seed = 500)

summary(train_without_dummyNA)
summary(train_imputed)
```

Outlier detection and standardization.

```{r}


```


We will do further adjustments to our data. 

```{r}

# var format transformations

train_without_dummyNA$price <- as.integer(train_without_dummyNA$price) # price is a factor variable otherwise
train_without_dummyNA$zipcode <- as.factor(train_without_dummyNA$zipcode) # zipcode should be factor - could even get more sophisticated (e.g. cantone...) with this one if time allows - the tax rate substantially differs across municipatlities in switzerland - that might well affect the prices of aparments




train_lin_subset <- train_without_dummyNA %>% select(-c("address", "municipality", "street", "year", "date", "date_available", "zipcode"))
```

Trying out a linear regression with k fold cross validation.

```{r}

lin_fit <- cv.lm(train_imputed, form.lm = formula(price ~.))

```


```{r}
md.pattern(train_lin_subset)
```

Hello Jingyan !;))
